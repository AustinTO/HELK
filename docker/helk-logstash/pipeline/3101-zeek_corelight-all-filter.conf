# HELK Zeek and Corelight main/all configuration
# HELK build Stage: Alpha
# Author: Roberto Rodriguez (@Cyb3rWard0g), Nate Guagenti (@neu5ron)
# License: GPL-3.0

filter {
  if [etl_kafka_topic] == "zeek" or [etl_kafka_topic] =~ "^corelight" {

    # (Original event) message field kept
    if [message] {
      # original event kept but not already JSON expanded
      if ![ts] {
        json {
          source => "message"
          tag_on_failure => [ "_parsefailure", "parsefailure-critical", "parsefailure-json_codec" ]
          remove_field => [ "message" ]
          add_field => { "etl_pipeline" => "zeek-json-conversion" }
          skip_on_invalid_json => true
        }

        # Rename 'source' field if it's a scalar (conflicts with ECS)
        
      }
      
      if [source] and ![source][ip] {
          mutate {
            rename => { "source" => "zeek_source" }
          }
        }# else, original event kept but JSON already applied nothing to do
    }

    # It's in the zeek kafka topic, but for some reason has no fields the way it should
    else if ![ts] {
      mutate {
        add_field => { "etl_pipeline" => "zeek-format-unkown" }
        add_tag => [ "parsefailure-critical" ]
      }
    }

    # Add ECS-compatible event_log tag
    mutate {
      add_field => {
        "event_log" => "zeek"
      }
    }

    # Corelight-specific logic
    if [_write_ts] {
      mutate {
        add_field => { "event_vendor" => "Corelight" }
      }
      date {
        match => [ "_write_ts", "ISO8601" ]
        timezone => "UTC"
        target => "event_recorded_time"
        remove_field => "_write_ts"
        tag_on_failure => [ "_parsefailure", "parsefailure-date-event_recorded_time", "parsefailure-date-_write_ts" ]
        add_field => { "etl_pipeline" => "zeek-corelight-date-_write_ts" }
      }
    }

    # Convert timestamp for @timestamp field
    if [event_vendor] == "Corelight" {
      date {
        match => [ "ts", "ISO8601" ]
        timezone => "UTC"
        target => "@timestamp"
        remove_field => "ts"
        tag_on_failure => [ "_parsefailure", "parsefailure-critical", "parsefailure-date-@timestamp", "parsefailure-date-corelight-ts" ]
        add_field => {
          "event_original_time" => "%{@timestamp}"
          "etl_pipeline" => "zeek_corelight_timestamp"
        }
      }
    } else {
      date {
        match => [ "ts", "UNIX" ]
        timezone => "UTC"
        target => "@timestamp"
        remove_field => "ts"
        tag_on_failure => [ "_parsefailure", "parsefailure-critical", "parsefailure-date-@timestamp", "parsefailure-date-zeek-ts" ]
        add_field => {
          "etl_pipeline" => "zeek_timestamp"
        }
      }
    }
  }
}
